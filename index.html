<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2025ë…„ ì—…ë¬´ì§€ì› ì„¤ë¬¸ì¡°ì‚¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 via-sky-50 to-indigo-50 text-slate-900">
  <div class="max-w-5xl mx-auto px-4 py-8">
    <!-- í—¤ë” -->
    <header class="mb-4">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-3 bg-clip-text text-transparent bg-gradient-to-r from-sky-600 via-indigo-600 to-emerald-600">
        2025ë…„ ì—…ë¬´ì§€ì› ì„¤ë¬¸ì¡°ì‚¬
      </h1>
      <p class="text-base md:text-lg text-slate-600">
        ê´€ì‹¬ ìˆëŠ” ì£¼ì œë¥¼ ì„ íƒí•œ ë’¤, ì„ íƒí•œ ì£¼ì œì— ëŒ€í•´ì„œë§Œ ì„¤ë¬¸ì„ ì§„í–‰í•©ë‹ˆë‹¤.
        ì„ íƒí•˜ì§€ ì•Šì€ ì£¼ì œëŠ” ì‹œìŠ¤í…œì—ì„œ ëª¨ë‘ <span class="font-semibold text-sky-700">ë¯¸ì‘ë‹µ</span>ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
      </p>
    </header>

    <!-- ê¸°ì¡´ ì‘ë‹µ ID ì•ˆë‚´ ë°°ë„ˆ -->
    <div
      id="current-id-banner"
      class="hidden mb-6 rounded-2xl border border-emerald-200 bg-emerald-50/80 px-4 py-3 text-sm md:text-base text-emerald-900 flex items-center gap-2"
    >
      <span class="text-lg">âœ…</span>
      <div>
        <span class="font-semibold">ì´ì „ì— ì‘ë‹µí•œ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤.</span>
        <span class="ml-2">ì‘ë‹µ ID: <span id="current-id-text" class="font-bold"></span></span>
      </div>
    </div>

    <!-- ì„¤ë¬¸ í”Œë¡œìš° ì˜ì—­ (ë‹¨ê³„ + ì„¤ë¬¸ í™”ë©´) -->
    <div id="survey-flow">
      <!-- ë‹¨ê³„ ì¸ë””ì¼€ì´í„° -->
      <div class="flex items-center gap-3 text-sm md:text-base mb-6">
        <div class="flex items-center gap-2">
          <div id="step-indicator-1" class="w-8 h-8 rounded-full flex items-center justify-center text-white bg-sky-600 text-xs font-semibold shadow-sm">
            1
          </div>
          <span class="font-semibold text-slate-800">ì£¼ì œ ì„ íƒ</span>
        </div>
        <div class="h-px flex-1 bg-gradient-to-r from-sky-200 via-slate-200 to-indigo-200"></div>
        <div class="flex items-center gap-2">
          <div id="step-indicator-2" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 border border-slate-200 text-xs font-semibold bg-white/70">
            2
          </div>
          <span class="font-semibold text-slate-400">ì„¤ë¬¸ ì‘ë‹µ</span>
        </div>
      </div>

      <!-- 1ë‹¨ê³„: ì£¼ì œ ì„ íƒ -->
      <section id="step-topics" class="space-y-6">
        <div class="flex items-center justify-between gap-4">
          <div>
            <h2 class="text-xl md:text-2xl font-bold mb-1 text-slate-900">ê´€ì‹¬ ìˆëŠ” ì£¼ì œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</h2>
            <p class="text-sm md:text-base text-slate-600">
              ì¤‘ë³µ ì„ íƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì„ íƒí•œ ì£¼ì œì— í•´ë‹¹í•˜ëŠ” í•­ëª©ë§Œ ì„¤ë¬¸ì— í‘œì‹œë©ë‹ˆë‹¤.
            </p>
          </div>
          <button
            id="btn-select-all-topics"
            type="button"
            class="inline-flex items-center rounded-xl border border-sky-500 bg-white/80 px-3 py-1.5 text-xs md:text-sm font-semibold text-sky-700 hover:bg-sky-50 shadow-sm"
          >
            ëª¨ë‘ ì„ íƒ
          </button>
        </div>

        <!-- ì£¼ì œ ëª©ë¡ -->
        <div id="topic-list" class="grid gap-4 md:grid-cols-2">
          <!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 mt-4">
          <button
            id="btn-go-to-survey"
            class="inline-flex items-center justify-center rounded-2xl border border-sky-600 bg-gradient-to-r from-sky-500 to-indigo-500 px-5 py-3 text-sm md:text-base font-semibold text-white shadow-md hover:from-sky-600 hover:to-indigo-600 active:scale-[0.99] transition-transform"
          >
            ë‹¤ìŒ ë‹¨ê³„ë¡œ
          </button>
        </div>
      </section>

      <!-- 2ë‹¨ê³„: ì„¤ë¬¸ -->
      <section id="step-survey" class="space-y-6 hidden">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl md:text-2xl font-bold mb-1 text-slate-900">ì„ íƒí•œ ì£¼ì œì— ëŒ€í•œ ì„¤ë¬¸</h2>
            <p class="text-sm md:text-base text-slate-600">
              ì„ íƒí•˜ì§€ ì•Šì€ ì£¼ì œì˜ ì‘ë‹µì€ ì‹œìŠ¤í…œì—ì„œ <span class="font-semibold text-sky-700">ë¯¸ì‘ë‹µ ì²˜ë¦¬</span>ë©ë‹ˆë‹¤.
            </p>
          </div>
          <button
            id="btn-back"
            type="button"
            class="inline-flex items-center justify-center rounded-xl border border-slate-300 bg-white/70 px-4 py-2 text-sm md:text-base font-medium text-slate-700 hover:bg-slate-100 shadow-sm"
          >
            &larr; ì£¼ì œ ë‹¤ì‹œ ì„ íƒ
          </button>
        </div>

        <form id="survey-form" class="space-y-6">
          <!-- JSì—ì„œ ì„¤ë¬¸ ë¬¸í•­ ì„¹ì…˜ ë™ì ìœ¼ë¡œ ìƒì„± -->

          <div class="flex justify-end gap-3 pt-4 border-t border-slate-200 mt-4">
            <button
              id="btn-temp-save"
              type="button"
              class="inline-flex items-center justify-center rounded-2xl border border-slate-300 bg-white/90 px-5 py-3 text-sm md:text-base font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
            >
              ì„ì‹œ ì €ì¥
            </button>
            <button
              id="btn-final-submit"
              type="button"
              class="inline-flex items-center justify-center rounded-2xl border border-emerald-600 bg-gradient-to-r from-emerald-500 to-teal-500 px-6 py-3 text-sm md:text-base font-semibold text-white shadow-md hover:from-emerald-600 hover:to-teal-600 active:scale-[0.99] transition-transform"
            >
              ì„¤ë¬¸ ì œì¶œ
            </button>
          </div>
        </form>
      </section>
    </div>

    <!-- ì œì¶œ ì™„ë£Œ í™”ë©´ -->
    <section
      id="completion-screen"
      class="hidden mt-10 flex flex-col items-center justify-center text-center"
    >
      <div class="max-w-xl w-full rounded-3xl border border-emerald-200 bg-emerald-50/90 px-6 py-10 shadow-md">
        <div class="text-4xl mb-3">ğŸ‰</div>
        <h2 class="text-2xl md:text-3xl font-bold text-emerald-800 mb-3">
          ì„¤ë¬¸ ì œì¶œì„ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤
        </h2>
        <p class="text-sm md:text-base text-emerald-900 mb-2">
          ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤. ë‚´ìš©ì€ í–¥í›„ ì—…ë¬´ì§€ì› ì„œë¹„ìŠ¤ ê°œì„ ì— ì ê·¹ ë°˜ì˜í•˜ê² ìŠµë‹ˆë‹¤.
        </p>
        <p class="text-xs md:text-sm text-emerald-900/80">
          ì‘ë‹µ ID: <span id="completion-id-text" class="font-semibold"></span>
        </p>
      </div>
    </section>
  </div>

  <script>
    // ==== ë³¸ì¸ Google Apps Script ì›¹ì•± URLë¡œ êµì²´ ====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzsZeMZE6-1Mgtpzuk2O9ORnO0Y-1k_BZg4xDydOoATeCevJimOjFdxG9kh4BSRVA2y/exec";
    // =================================================

    // ìƒíƒœ ì €ì¥ìš©
    let clientIp = "";
    let previousId = null;
    let previousAnswers = null; // { Q1: "...", ... }
    let previousStatus = null;  // "TEMP" | "FINAL" | null
    let isFinalSubmitted = false;

    // DOM ìš”ì†Œ
    const topicListEl = document.getElementById("topic-list");
    const stepTopicsEl = document.getElementById("step-topics");
    const stepSurveyEl = document.getElementById("step-survey");
    const btnGoToSurvey = document.getElementById("btn-go-to-survey");
    const btnBack = document.getElementById("btn-back");
    const surveyForm = document.getElementById("survey-form");
    const stepIndicator1 = document.getElementById("step-indicator-1");
    const stepIndicator2 = document.getElementById("step-indicator-2");
    const currentIdBanner = document.getElementById("current-id-banner");
    const currentIdText = document.getElementById("current-id-text");
    const surveyFlowEl = document.getElementById("survey-flow");
    const completionScreenEl = document.getElementById("completion-screen");
    const completionIdText = document.getElementById("completion-id-text");
    const btnSelectAllTopics = document.getElementById("btn-select-all-topics");
    const btnTempSave = document.getElementById("btn-temp-save");
    const btnFinalSubmit = document.getElementById("btn-final-submit");

    // ì„ íƒëœ ì£¼ì œ
    let selectedTopicIds = new Set();

    // ë§Œì¡±ë„ ê³µí†µ ì˜µì…˜
    const satisfactionOptions = [
      "ë§¤ìš° ë§Œì¡±",
      "ëŒ€ì²´ë¡œ ë§Œì¡±",
      "ë³´í†µ",
      "ëŒ€ì²´ë¡œ ë¶ˆë§Œ",
      "ë§¤ìš° ë¶ˆë§Œ"
    ];

    // ì œëª© ì´ëª¨ì§€
    const topicEmojis = {
      interior: "ğŸ›‹ï¸",
      office_furniture: "ğŸª‘",
      anniversary: "ğŸ‰",
      moving: "ğŸšš",
      access_card: "ğŸ«",
      affiliation_discount: "ğŸ·ï¸",
      volunteering: "ğŸ¤",
      parking: "ğŸ…¿ï¸",
      scent_system: "ğŸŒ¸",
      snack24: "ğŸª",
      chobok_bingsu: "ğŸ§",
      credit_rating_event: "ğŸ“ˆ",
      christmas_tree: "ğŸ„",
      etc: "ğŸ“"
    };

    // ì„¤ë¬¸ ë°ì´í„° (ì´ì „ê³¼ ë™ì¼)
    const topics = [
      {
        id: "interior",
        title: "ì¸í…Œë¦¬ì–´",
        summary: "ì‹œê·¸ë‹ˆì³íƒ€ì›Œ ì¸í…Œë¦¬ì–´Â·ë¼ìš´ì§€Â·ì‚¬ë¬´ê³µê°„ ë§Œì¡±ë„ ì¡°ì‚¬",
        description:
          "ã…‡ ì¸í…Œë¦¬ì–´ ì—…ì²´ ì„ ì •(2024.9ì›”), ì¸í…Œë¦¬ì–´ ì„¤ê³„ í›„ 2025.1.1ë¶€í„° 25.4.30ì¼ê¹Œì§€ ì¸í…Œë¦¬ì–´ ê³µì‚¬ ì‹¤ì‹œ",
        questions: [
          { number: 1, text: "ì‹œê·¸ë‹ˆì³íƒ€ì›Œ ì¸í…Œë¦¬ì–´ ì „ë°˜ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ” ì–´ë–»ìŠµë‹ˆê¹Œ? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 2, text: "ë¼ìš´ì§€ ê³µê°„ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ” ì–´ë–»ìŠµë‹ˆê¹Œ? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 3, text: "ì‚¬ë¬´ê³µê°„ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ” ì–´ë–»ìŠµë‹ˆê¹Œ? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 4, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "office_furniture",
        title: "ì‚¬ë¬´ê°€êµ¬",
        summary: "6ì¸µ ëª©ì—…ê°€êµ¬ ë° ì‚¬ë¬´ê°€êµ¬ ì„ ì • ê³¼ì • ë§Œì¡±ë„ ì¡°ì‚¬",
        description:
          "ã…‡ ì½”ë¦¬ì•ˆë¦¬ë¹Œë”© 6ì¸µì— ëª©ì—…ê°€êµ¬ ë°°ì¹˜ ë° ì§ì› ì˜ê²¬ ìˆ˜ë ´, ì„ ì •ëœ 19ëª… ì§ì› ëŒ€ìƒìœ¼ë¡œ ì„¤ëª…íšŒ ê°œìµœ ë° ì—…ì²´ ì„ ì •(2025.1.10)",
        questions: [
          { number: 5, text: "ì‚¬ë¬´ê°€êµ¬ ë° ëª©ì—…ê°€êµ¬ í’ˆí‰íšŒ ê´€ë ¨ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 6, text: "ì„ ì •ëœ ì‚¬ë¬´ê°€êµ¬ ì œí’ˆì— ëŒ€í•œ í‰ê°€ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 7, text: "6ì¸µ ëª©ì—…ê°€êµ¬ í…ŒìŠ¤íŠ¸ ë° ì„¤ëª…íšŒì— ëŒ€í•œ í‰ê°€ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 8, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "anniversary",
        title: "ì°½ë¦½ê¸°ë… í–‰ì‚¬",
        summary: "ì°½ë¦½ê¸°ë…ì‹ í–‰ì‚¬Â·ì¶œì¥ë·”í˜Â·ë¨¸ê·¸ì»µ ê¸°ë…í’ˆ ë§Œì¡±ë„",
        description:
          "ã…‡ 2025.3.19ì¼ ì°½ë¦½ê¸°ë…ì¼ì„ ë§ì´í•˜ì—¬ ì¶œì¥ë·”í˜ í–‰ì‚¬ë¥¼ ì§„í–‰(12ì¸µê³¼ 6ì¸µ), ê¸°ë…í’ˆìœ¼ë¡œ ì‚¬ì˜¥ ì´ë¯¸ì§€ê°€ ë¨¸ê·¸ì»µ ë°°í¬",
        questions: [
          { number: 9, text: "ì°½ë¦½ê¸°ë…ì‹ í–‰ì‚¬ ë° ë¨¸ê·¸ì»µ ê¸°ë…í’ˆì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 10, text: "ì°½ë¦½ê¸°ë…ì‹ í–‰ì‚¬ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 11, text: "ê¸°ë…í’ˆ ë¨¸ê·¸ì»µì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 12, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "moving",
        title: "ì´ì‚¬",
        summary: "ì‚¬ì˜¥ ì´ì‚¬ ì ˆì°¨ ë° ì•ˆë‚´ì— ëŒ€í•œ ë§Œì¡±ë„",
        description:
          "ã…‡ ì´ì‚¬ê´€ë ¨ ì•ˆë‚´ ê³µì§€(2025.4.7ì¼), 4.11ì¼~4.13ì¼ ë³¸ ì´ì‚¬ ì‹¤ì‹œ, 4.26ì¼ì— í›„ì† ì´ì‚¬ë¥¼ ì§„í–‰ (4ì›”4ì¼ ì´ì‚¬ì„¤ëª…íšŒëŠ” ì¬íƒê·¼ë¬´ë¡œ ì·¨ì†Œ)",
        questions: [
          { number: 13, text: "ì‚¬ì˜¥ ì´ì‚¬ ê³¼ì •ì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 14, text: "ì‚¬ì˜¥ ì´ì‚¬ ê³¼ì •ì—ì„œ ë§¡ì•˜ë˜ ì—­í• ì€? (ë‹¨ë‹µí˜•, ë³µìˆ˜ì„ íƒ)", type: "multi", options: ["ì¶œë°œë‹´ë‹¹ì", "ë„ì°©ë‹´ë‹¹ì", "ì´ë¬´ì„œë¬´", "ì—­í• ì—†ìŒ", "ê¸°íƒ€"], hasOther: true },
          { number: 15, text: "í–¥í›„ ì´ì‚¬ ì‹œ ë°˜ì˜ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ì˜ê²¬ì´ ìˆìœ¼ì‹  ê²½ìš° ì•Œë ¤ì£¼ì„¸ìš”. (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "access_card",
        title: "ì¶œì…ì¦",
        summary: "ì¶œì…ì¦ ì¹´ë“œì™€ ì‹ ì²­Â·ì¬ë°œê¸‰ í”„ë¡œì„¸ìŠ¤ ë§Œì¡±ë„",
        description:
          "ã…‡ ì‹œê·¸ë‹ˆì³íƒ€ì›Œ ë³´ì•ˆê´€ë¦¬ ì‹œìŠ¤í…œ ì„¤ì¹˜ ë° ì¶œì…ì¦ ë°°í¬ (2025.4.8ì¼ë¶€í„°)\nã…‡ ì‚¬ì›ì¦/ë°©ë¬¸ì¦ ì‹ ì²­ ì‹œ ì¸ì‚¬ì´ë¬´íŒ€ì— í˜‘ì¡°ì „ì„ ë°œì†¡, ë¶„ì‹¤ì— ëŒ€í•œ ê²½ê°ì‹¬ ì œê³  ë° ê¸°ë¡ê´€ë¦¬ë¥¼ ìœ„í•´ ë¶„ì‹¤ ì‹œ ì‚¬ìœ ì„œë¥¼ ì²¨ë¶€.",
        questions: [
          { number: 16, text: "ì¶œì…ì¦ ì¹´ë“œ ì œí’ˆ, ì—…ë¬´í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 17, text: "ì¶œì…ì¦ ì¹´ë“œ ì œí’ˆì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 18, text: "ì¶œì…ì¦ ì‹ ì²­ ë° ì¬ë°œê¸‰ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 19, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "affiliation_discount",
        title: "ì œíœ´í• ì¸",
        summary: "ê±´ë¬¼ ë‚´ ì œíœ´í• ì¸ ë° LGì „ì ë³µì§€ëª° ë§Œì¡±ë„",
        description:
          "ã…‡ ì…ì£¼ì‹œê¸°ì— ë§ì¶”ì–´ ì‹œê·¸ë‹ˆì³ íƒ€ì›Œ ë‚´ ìƒê°€ ì œíœ´í• ì¸ ì•½ì •\nã…‡ ì½”ë¦¬ì•ˆë¦¬ LGì „ì ë³µì§€ëª° ì˜¤í”ˆ(2025.11.20ì¼ë¶€í„°)",
        questions: [
          { number: 20, text: "ì œíœ´í• ì¸ ì „ë°˜ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 21, text: "ê±´ë¬¼ ë‚´ ì œíœ´ í• ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 22, text: "ì´ìš©í•´ë³¸ ì œíœ´ ì„œë¹„ìŠ¤ëŠ”? (ë‹¨ë‹µí˜•, ë³µìˆ˜ì„ íƒ)", type: "multi", options: ["ì‹ë‹¹", "ì»¤í”¼", "ìŠ¤í¬ì¸ ì„¼í„°", "ìŠ¤ì¼€ì³ìŠ¤", "ì™€ì¸"] },
          { number: 23, text: "LGì „ì ë³µì§€ëª°ì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 24, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "volunteering",
        title: "ë´‰ì‚¬í™œë™",
        summary: "í•´ë¹„íƒ€íŠ¸Â·ìš°ë¦¬ë™ë„¤í¬ë§ë‚˜ëˆ” ë“± ë´‰ì‚¬í™œë™ ë§Œì¡±ë„",
        description:
          "ã…‡ ìƒë°˜ê¸°: í•´ë¹„íƒ€íŠ¸(3ê¸°ìˆ˜), ìš°ë¦¬ë™ë„¤í¬ë§ë‚˜ëˆ”(4ê¸°ìˆ˜), í•˜ì²œì •í™”(4ê¸°ìˆ˜), í•´ì–‘ì“°ë ˆê¸°(3ê¸°ìˆ˜) ìš´ì˜\nã…‡ í•˜ë°˜ê¸°: ìš°ë¦¬ë™ë„¤í¬ë§ë‚˜ëˆ”(3ê¸°ìˆ˜), í•˜ì²œì •í™”(2ê¸°ìˆ˜), í•´ì–‘ì“°ë ˆê¸°(2ê¸°ìˆ˜), ì¥í•­ìŠµì§€(1ê¸°ìˆ˜) ìš´ì˜",
        questions: [
          { number: 25, text: "ì°¸ì„í•˜ì‹  ë´‰ì‚¬í™œë™ì„ ì„ íƒí•´ ì£¼ì„¸ìš”. (ë‹¨ë‹µí˜•)", type: "single", options: ["í•´ì–‘ì“°ë ˆê¸°", "ìš°ë¦¬ë™ë„¤í¬ë§ë‚˜ëˆ”", "í•´ë¹„íƒ€íŠ¸", "ì¥í•­ìŠµì§€", "í•˜ì²œì •í™”"] },
          { number: 26, text: "ë´‰ì‚¬í™œë™ì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 27, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" },
          { number: 28, text: "í–¥í›„ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë´‰ì‚¬í™œë™ì´ ìˆìœ¼ì‹  ê²½ìš° ììœ ë¡­ê²Œ ì¨ì£¼ì„¸ìš”. (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "parking",
        title: "ì£¼ì°¨",
        summary: "ì‹œê·¸ë‹ˆì³íƒ€ì›Œ ì£¼ì°¨ ì‹œë²”Â·ë³¸ ìš´ì˜ ë§Œì¡±ë„",
        description:
          "ã…‡ 2025.4.14~6.30 ë™ì•ˆ ì¶”ì²¨ì„ í†µí•œ ë¬´ë£Œ ì‹œë²”ìš´ì˜ ì‹¤ì‹œ\nã…‡ 2025.7.1ì¼ë¶€í„° ì¶”ì²¨ìœ¼ë¡œ 6ê°œì›” ë‹¨ìœ„ ì£¼ì°¨ì¥ ì´ìš©(ì›” ìš”ê¸ˆ 130,220ì›)\nã…‡ ì „ì›” 24ì¼ê¹Œì§€ ì·¨ì†Œ, ì°¨ìˆœìœ„ ëŒ€ê¸°ìì—ê²Œ ì„ íƒê¶Œ ë¶€ì—¬",
        questions: [
          { number: 29, text: "ì‹œê·¸ë‹ˆì³íƒ€ì›Œ ì£¼ì°¨ì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 30, text: "ì‹œë²”ìš´ì˜ê¸°ê°„ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 31, text: "ë³¸ ìš´ì˜ê¸°ê°„ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 32, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "scent_system",
        title: "ë°©í–¥ì‹œìŠ¤í…œ",
        summary: "ë¼ìš´ì§€ ë°©í–¥(í–¥ê¸°)ì‹œìŠ¤í…œ ì„¤ì¹˜ íš¨ê³¼ ë° ë§Œì¡±ë„",
        description:
          "ã…‡ ì¸í…Œë¦¬ì–´ ë° ê¿‰ê¿‰í•œ ì¹´í˜íŠ¸ ëƒ„ìƒˆ ì œê±° ëª©ì ìœ¼ë¡œ ê° ë¼ìš´ì§€ì— ë°©í–¥(í–¥ê¸°)ì‹œìŠ¤í…œ ì„¤ì¹˜(2025.8.1ì¼ë¶€í„°)",
        questions: [
          { number: 33, text: "ë°©í–¥ì‹œìŠ¤í…œì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 34, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "snack24",
        title: "ìŠ¤ë‚µ24",
        summary: "ìŠ¤ë‚µ24 ì„œë¹„ìŠ¤Â·ìƒí’ˆêµ¬ì„±Â·í¬ì¸íŠ¸ ìˆ˜ì¤€ ë§Œì¡±ë„",
        description:
          "ã…‡ ê¸°ì¡´ ë¶€ë¹„í†µì¥ìœ¼ë¡œ ì§€ê¸‰ë˜ë˜ ë¶€ë¹„ì˜ ì¼ë¶€ë¥¼ ìŠ¤ë‚µ24 í¬ì¸íŠ¸ë¡œ ì „í™˜í•˜ì—¬ ì§€ê¸‰\nã…‡ ìŠ¤ë‚µ24 í†µí•˜ì—¬ ë¼ìš´ì§€ë³„ ìŠ¤ë‚µë°”ë¥¼ ì„¤ì¹˜í•˜ê³  ìš´ì˜",
        questions: [
          { number: 35, text: "ìŠ¤ë‚µ24 ì„œë¹„ìŠ¤ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 36, text: "ìƒí’ˆêµ¬ì„±ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 37, text: "êµ¬ë§¤ í”„ë¡œì„¸ìŠ¤ì— ëŒ€í•œ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 38, text: "í¬ì¸íŠ¸ëŠ” ì–´ëŠ ì •ë„ ìˆ˜ì¤€ì´ ì ì ˆí•˜ë‹¤ê³  ìƒê°í•˜ëŠ”ì§€? (ë‹¨ë‹µí˜•)", type: "single", options: ["4.5ë§Œì›(ì „ì•¡)", "4ë§Œì›", "3ë§Œì›(í˜„í–‰)", "2ë§Œì›(ì¶•ì†Œ)", "ë‹¤ì‹œ ë¶€ë¹„ë¡œ ì „í™˜"] },
          { number: 39, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "chobok_bingsu",
        title: "ì´ˆë³µ ì»µë¹™ìˆ˜",
        summary: "ì´ˆë³µ ì»µë¹™ìˆ˜(íŒ¥ë¹™ìˆ˜/ë§ê³ ë¹™ìˆ˜) í–‰ì‚¬ ë§Œì¡±ë„",
        description:
          "ã…‡ ì´ˆë³µ ìˆ˜ë°•ë„ì‹œë½ì„ ì´ˆë³µ ì»µë¹™ìˆ˜(íŒ¥ë¹™ìˆ˜/ë§ê³ ë¹™ìˆ˜) í–‰ì‚¬ë¡œ ì „í™˜",
        questions: [
          { number: 40, text: "ì´ˆë³µ ì»µë¹™ìˆ˜ì— ëŒ€í•œ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 41, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "credit_rating_event",
        title: "ì‹ ìš©ë“±ê¸‰ ìƒí–¥í–‰ì‚¬",
        summary: "S&P ì‹ ìš©ë“±ê¸‰ ìƒí–¥ ê´€ë ¨ ë¼ìš´ì§€ í–‰ì‚¬ ë§Œì¡±ë„",
        description:
          "ã…‡ ë‹¹ì‚¬ S&P ì‹ ìš©ë“±ê¸‰ ìƒí–¥ì— ë”°ë¥¸ 4F ë¼ìš´ì§€ í–‰ì‚¬\nã…‡ ì¶œì¥ë·”í˜ í†µí•œ ë””ì €íŠ¸ ë° ìŒë£Œ ì œê³µ",
        questions: [
          { number: 42, text: "ì‹ ìš©ë“±ê¸‰ ìƒí–¥í‰ê°€ ê´€ë ¨ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 43, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "christmas_tree",
        title: "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬",
        summary: "ë¼ìš´ì§€Â·ë³µë„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ì„¤ì¹˜ ë§Œì¡±ë„",
        description:
          "ã…‡ ë¼ìš´ì§€ ë° ë³µë„ì— í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ì„¤ì¹˜(2025.12.3ì¼ë¶€í„°)",
        questions: [
          { number: 44, text: "í¬ë¦¬ìŠ¤ë§ˆìŠ¤ íŠ¸ë¦¬ ì„¤ì¹˜ ê´€ë ¨ ì „ë°˜ì ì¸ ë§Œì¡±ë„ëŠ”? (ë‹¨ë‹µí˜•)", type: "single", options: satisfactionOptions },
          { number: 45, text: "ë§Œì¡±í–ˆë˜ ì´ìœ ì™€ ë¶ˆë§Œì¡±í•œ ì´ìœ , ê°œì„ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ë¶€ë¶„ì€? (ì£¼ê´€ì‹)", type: "text" }
        ]
      },
      {
        id: "etc",
        title: "ê¸°íƒ€",
        summary: "ëª…ì ˆì„ ë¬¼Â·ê°ì¢… ì„œë¹„ìŠ¤ ë° ê¸°íƒ€ ê°œì„  ì˜ê²¬",
        description: "ê¸°íƒ€ ì—…ë¬´ì§€ì› ê´€ë ¨ ì„œë¹„ìŠ¤ ë° ê°œì„  ì˜ê²¬",
        questions: [
          { number: 46, text: "ëª…ì ˆì„ ë¬¼(ê³ ê¸°/ìƒì„ )ì— ê°œì„ ì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ëŠ” ë¶€ë¶„ì€? (ë‹¨ë‹µí˜•, ë³µìˆ˜ì„ íƒ)", type: "multi", options: ["ë‹¨ê°€ì¸ìƒ", "ë³µì§€ëª°ë¡œ ì „í™˜", "ì—…ì²´ë³€ê²½", "ìƒí’ˆêµ¬ì„±ë³€ê²½", "í˜„í–‰ìœ ì§€"] },
          { number: 47, text: "46ë²ˆì—ì„œ í˜„í–‰ìœ ì§€ ì™¸ì— ì„ íƒí•˜ì‹  ê²½ìš° ì„¸ë¶€ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”. (ì£¼ê´€ì‹)", type: "text" },
          { number: 48, text: "í˜„í–‰ìœ ì§€ ì¤‘ì¸ ì„œë¹„ìŠ¤ ì¤‘ ê°œì„ ì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ëŠ” ì„œë¹„ìŠ¤ëŠ”? (ë‹¨ë‹µí˜•, ë³µìˆ˜ì„ íƒ)", type: "multi", options: ["ë§ì½”(ì‚¬ë¬´ìš©í’ˆ)", "A4ìš©ì§€(ì‚¬ë¬´ìš©í’ˆ)", "ë¬´ë£Œ ì•„ì´ìŠ¤í¬ë¦¼", "ê³µê¸°ì²­ì •ê¸°", "ê¸°íƒ€"], hasOther: true },
          { number: 49, text: "ê°œì„ ì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ëŠ” ì´ìœ ì™€ ë°©ë²•ì€? (ì£¼ê´€ì‹)", type: "text" },
          { number: 50, text: "ê¸°íƒ€ ì—…ë¬´ì§€ì›íŒŒíŠ¸ì— ìš”ì²­í•˜ê³  ì‹¶ì€ ê°œì„ ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì ì–´ì£¼ì„¸ìš”. (ì£¼ê´€ì‹)", type: "text" }
        ]
      }
    ];

    // IP ê°€ì ¸ì˜¤ê¸°
    async function fetchClientIp() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        clientIp = data.ip;
        console.log("Client IP:", clientIp);
      } catch (e) {
        console.error("IP ì¡°íšŒ ì‹¤íŒ¨:", e);
      }
    }

    // ê¸°ì¡´ ì‘ë‹µ ì¡°íšŒ
    async function loadPreviousResponse() {
      if (!clientIp) return;
      try {
        const res = await fetch(`${SCRIPT_URL}?ip=${encodeURIComponent(clientIp)}`);
        if (!res.ok) {
          console.warn("ì´ì „ ì‘ë‹µ ì¡°íšŒ ì‹¤íŒ¨:", res.status);
          return;
        }
        const data = await res.json();
        if (data && data.exists) {
          previousId = data.ID;
          previousStatus = data.STATUS || null;

          if (previousStatus === "FINAL") {
            isFinalSubmitted = true;
            if (previousId) {
              completionIdText.textContent = previousId;
            }
            showCompletionScreen();
            return;
          }

          previousAnswers = {};
          for (let i = 1; i <= 50; i++) {
            const key = "Q" + i;
            previousAnswers[key] = data[key] || "";
          }

          currentIdText.textContent = previousId;
          currentIdBanner.classList.remove("hidden");
        }
      } catch (e) {
        console.error("loadPreviousResponse ì—ëŸ¬:", e);
      }
    }

    // ì£¼ì œ ì¹´ë“œ ë Œë”ë§
    function renderTopicCards() {
      topicListEl.innerHTML = "";

      topics.forEach((topic) => {
        const card = document.createElement("label");
        card.className =
          "group relative flex cursor-pointer flex-col rounded-2xl border border-sky-100 bg-white/80 p-4 shadow-sm hover:shadow-lg hover:border-sky-300 hover:bg-sky-50/70 transition-all";

        const summaryText = topic.summary || topic.description.split("\n")[0];

        card.innerHTML = `
          <div class="flex items-start gap-3">
            <input
              type="checkbox"
              class="mt-1 h-5 w-5 rounded border-slate-300 text-sky-600 focus:ring-sky-500"
              value="${topic.id}"
            />
            <div class="flex-1">
              <div class="flex items-center justify-between gap-2">
                <h3 class="text-base md:text-lg font-semibold text-slate-900">
                  ${topicEmojis[topic.id] || "ğŸ“Œ"} ${topic.title}
                </h3>
                <span class="text-[11px] md:text-xs px-2 py-0.5 rounded-full border border-slate-200 text-slate-400 bg-slate-50 group-has-[:checked]:bg-sky-100 group-has-[:checked]:text-sky-800 group-has-[:checked]:border-sky-300">
                  ì£¼ì œ ì„ íƒ
                </span>
              </div>
              <p class="mt-1 text-xs md:text-sm text-slate-600 line-clamp-2">
                ${summaryText}
              </p>
            </div>
          </div>
        `;

        topicListEl.appendChild(card);
      });
    }

    // ì§ˆë¬¸ HTML ìƒì„±
    function createQuestionHtml(topic, q) {
      let inputHtml = "";

      if (q.type === "single") {
        const opts = q.options && q.options.length ? q.options : satisfactionOptions;
        inputHtml = `
          <div class="flex flex-wrap items-center gap-3">
            ${opts.map(
              opt => `
              <label class="inline-flex items-center gap-1.5 text-sm md:text-base text-slate-700">
                <input
                  type="radio"
                  name="answers[${q.number}][choice]"
                  value="${opt}"
                  class="h-4 w-4 text-sky-600 border-slate-300 focus:ring-sky-500"
                />
                <span>${opt}</span>
              </label>
            `
            ).join("")}
          </div>
        `;
      } else if (q.type === "multi") {
        inputHtml = `
          <div class="flex flex-wrap items-center gap-3">
            ${q.options.map(
              opt => `
              <label class="inline-flex items-center gap-1.5 text-sm md:text-base text-slate-700">
                <input
                  type="checkbox"
                  name="answers[${q.number}][choices][]"
                  value="${opt}"
                  class="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500"
                />
                <span>${opt}</span>
              </label>
            `
            ).join("")}
          </div>
          ${q.hasOther ? `
          <div class="mt-3">
            <input
              type="text"
              name="answers[${q.number}][other]"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm md:text-base text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500/70 focus:border-indigo-500"
              placeholder="ê¸°íƒ€ë¥¼ ì„ íƒí•˜ì‹  ê²½ìš°, êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."
            />
          </div>` : ""}
        `;
      } else if (q.type === "text") {
        inputHtml = `
          <textarea
            name="answers[${q.number}][text]"
            rows="3"
            class="mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm md:text-base text-slate-800 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500/70 focus:border-emerald-500"
            placeholder="ììœ ë¡­ê²Œ ì˜ê²¬ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”."
          ></textarea>
        `;
      }

      return `
        <div class="rounded-2xl bg-white px-4 py-4 md:px-5 md:py-5 border border-sky-100 shadow-sm">
          <div class="flex items-start gap-2 mb-2">
            <span class="mt-0.5 inline-flex items-center justify-center rounded-full bg-sky-100 text-sky-700 text-xs md:text-sm font-semibold px-2 py-0.5">
              Q${q.number}
            </span>
            <p class="text-base md:text-lg font-semibold text-slate-900 leading-snug">
              ${q.text}
            </p>
          </div>
          <div class="mt-2">
            ${inputHtml}
          </div>
        </div>
      `;
    }

    // ì„¤ë¬¸ í¼ êµ¬ì„± (ì„ íƒí•œ ì£¼ì œë§Œ)
    function renderSurveyForm() {
      surveyForm.querySelectorAll(".topic-section").forEach(el => el.remove());

      const fragment = document.createDocumentFragment();
      const selectedTopics = topics.filter(t => selectedTopicIds.has(t.id));

      selectedTopics.forEach((topic) => {
        const section = document.createElement("section");
        section.className =
          "topic-section rounded-2xl border border-sky-100 bg-white/90 p-4 md:p-5 shadow-md";

        const descHtml = topic.description.replace(/\n/g, "<br />");
        const questionsHtml = topic.questions.map(q => createQuestionHtml(topic, q)).join("");

        section.innerHTML = `
          <div class="flex items-start justify-between gap-3 mb-4">
            <div>
              <h3 class="text-lg md:text-xl font-bold text-slate-900">
                ${topicEmojis[topic.id] || "ğŸ“Œ"} ${topic.title}
              </h3>
              <p class="mt-1 text-sm md:text-base text-slate-600">
                ${descHtml}
              </p>
            </div>
          </div>
          <div class="space-y-5">
            ${questionsHtml}
          </div>
        `;

        fragment.appendChild(section);
      });

      const submitBtnWrapper = surveyForm.lastElementChild;
      surveyForm.insertBefore(fragment, submitBtnWrapper);

      // ì´ì „ ì‘ë‹µ ìˆìœ¼ë©´ ê°’ ì±„ìš°ê¸°
      applyPreviousAnswers();
    }

    // ì´ì „ ì‘ë‹µì„ í¼ì— ë°˜ì˜
    function applyPreviousAnswers() {
      if (!previousAnswers) return;

      topics.forEach(topic => {
        if (!selectedTopicIds.has(topic.id)) return;

        topic.questions.forEach(q => {
          const key = "Q" + q.number;
          const val = previousAnswers[key];
          if (!val) return;

          if (q.type === "single") {
            const radios = surveyForm.querySelectorAll(
              `input[name="answers[${q.number}][choice]"]`
            );
            radios.forEach(r => {
              if (r.value === val) r.checked = true;
            });
          } else if (q.type === "multi") {
            const parts = val.split(",").map(s => s.trim()).filter(Boolean);
            const checks = surveyForm.querySelectorAll(
              `input[name="answers[${q.number}][choices][]"]`
            );
            checks.forEach(chk => {
              if (parts.includes(chk.value)) chk.checked = true;
            });
            const otherPart = parts.find(p => p.startsWith("ê¸°íƒ€:"));
            if (otherPart) {
              const input = surveyForm.querySelector(
                `input[name="answers[${q.number}][other]"]`
              );
              if (input) {
                input.value = otherPart.replace(/^ê¸°íƒ€:\s*/, "");
              }
            }
          } else if (q.type === "text") {
            const ta = surveyForm.querySelector(
              `textarea[name="answers[${q.number}][text]"]`
            );
            if (ta) ta.value = val;
          }
        });
      });
    }

    // Q1~Q50 ê°’ ìˆ˜ì§‘
    function collectAnswersByQuestion() {
      const result = {};

      topics.forEach(topic => {
        topic.questions.forEach(q => {
          const key = "Q" + q.number;

          if (q.type === "single") {
            const input = surveyForm.querySelector(
              `input[name="answers[${q.number}][choice]"]:checked`
            );
            result[key] = input ? input.value : "";
          } else if (q.type === "multi") {
            const checks = surveyForm.querySelectorAll(
              `input[name="answers[${q.number}][choices][]"]:checked`
            );
            const values = Array.from(checks).map(c => c.value);
            const otherInput = surveyForm.querySelector(
              `input[name="answers[${q.number}][other]"]`
            );
            if (otherInput && otherInput.value.trim()) {
              values.push("ê¸°íƒ€: " + otherInput.value.trim());
            }
            result[key] = values.join(", ");
          } else if (q.type === "text") {
            const ta = surveyForm.querySelector(
              `textarea[name="answers[${q.number}][text]"]`
            );
            result[key] = ta ? ta.value.trim() : "";
          }
        });
      });

      return result;
    }

    // ëª¨ë‘ ì„ íƒ ë²„íŠ¼
    function selectAllTopics() {
      const checkboxes = topicListEl.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(cb => {
        cb.checked = true;
      });
    }

    // ë‹¨ê³„ ì „í™˜
    function goToSurveyStep() {
      const checkboxes = topicListEl.querySelectorAll("input[type='checkbox']");
      selectedTopicIds = new Set(
        Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value)
      );

      if (selectedTopicIds.size === 0) {
        alert("ìµœì†Œ 1ê°œ ì´ìƒì˜ ì£¼ì œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      renderSurveyForm();

      stepTopicsEl.classList.add("hidden");
      stepSurveyEl.classList.remove("hidden");

      stepIndicator1.className =
        "w-8 h-8 rounded-full flex items-center justify-center text-slate-500 border border-slate-200 text-xs font-semibold bg-white/80";
      stepIndicator2.className =
        "w-8 h-8 rounded-full flex items-center justify-center text-white bg-indigo-600 text-xs font-semibold shadow-sm";
    }

    function backToTopicStep() {
      stepSurveyEl.classList.add("hidden");
      stepTopicsEl.classList.remove("hidden");

      stepIndicator1.className =
        "w-8 h-8 rounded-full flex items-center justify-center text-white bg-sky-600 text-xs font-semibold shadow-sm";
      stepIndicator2.className =
        "w-8 h-8 rounded-full flex items-center justify-center text-slate-400 border border-slate-200 text-xs font-semibold bg-white/70";
    }

    // ì œì¶œ ì™„ë£Œ í™”ë©´ ë³´ì—¬ì£¼ê¸°
    function showCompletionScreen() {
      isFinalSubmitted = true;
      surveyFlowEl.classList.add("hidden");
      completionScreenEl.classList.remove("hidden");
      if (previousId) {
        completionIdText.textContent = previousId;
      }
    }

    // ì„œë²„ë¡œ ì €ì¥ (mode: "TEMP" | "FINAL")
    async function saveSurvey(mode) {
      const answers = collectAnswersByQuestion();

      const payload = {
        IP: clientIp || "",
        mode: mode
      };

      for (let i = 1; i <= 50; i++) {
        const key = "Q" + i;
        payload[key] = answers[key] || "";
      }

      console.log("ì „ì†¡ ë°ì´í„°:", payload);

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json();
        if (data && data.status === "ok") {
          if (data.ID) {
            previousId = data.ID;
            currentIdText.textContent = previousId;
            currentIdBanner.classList.remove("hidden");
            completionIdText.textContent = previousId;
          }

          if (mode === "TEMP") {
            alert("ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
          } else if (mode === "FINAL") {
            alert("ì„¤ë¬¸ ì œì¶œì„ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.");
            showCompletionScreen();
          }
        } else {
          alert("ì €ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      } catch (error) {
        console.error("ì „ì†¡ ì˜¤ë¥˜:", error);
        alert("ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      }
    }

    // ì´ˆê¸° ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", async () => {
      await fetchClientIp();
      await loadPreviousResponse();

      if (!isFinalSubmitted) {
        renderTopicCards();
        btnGoToSurvey.addEventListener("click", goToSurveyStep);
        btnBack.addEventListener("click", backToTopicStep);
        btnSelectAllTopics.addEventListener("click", selectAllTopics);
        btnTempSave.addEventListener("click", () => saveSurvey("TEMP"));
        btnFinalSubmit.addEventListener("click", () => saveSurvey("FINAL"));
      }
    });
  </script>
</body>
</html>
